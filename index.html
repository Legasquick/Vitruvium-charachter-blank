<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Лист персонажа Витрувий</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;600;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Основные стили */
    :root {
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      background-color: #e7e5e4; /* Stone-200 */
      font-family: 'Inter', sans-serif;
      color: #1c1917;
      -webkit-font-smoothing: antialiased;
      
      /* Отступ снизу страницы, чтобы контент не перекрывался плавающим меню */
      /* Высота меню (~70px) + отступ от низа (16px) + safe area */
      padding-bottom: calc(90px + var(--safe-bottom));
      
      /* Блокируем "резиновый" скролл всей страницы на iOS, чтобы меню визуально не плавало отдельно от фона */
      overscroll-behavior-y: none; 
    }

    @media (min-width: 768px) {
        body { 
            padding-bottom: 0; 
            overscroll-behavior-y: auto;
        }
    }

    .font-header { font-family: 'Cinzel', serif; }
    .font-hand { font-family: 'Merriweather', serif; }
    
    /* Убираем стрелки у input number */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; margin: 0; 
    }

    /* --- НАСТРОЙКИ ПЕЧАТИ --- */
    @media print {
      @page { size: A4; margin: 0; }
      body { background: white; margin: 0; padding: 0; }
      
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .no-print { display: none !important; }
      
      .sheet-page {
        width: 210mm !important;
        max-width: 210mm !important;
        min-height: 297mm !important;
        margin: 0 !important;
        padding: 10mm 12mm !important;
        box-shadow: none !important;
        page-break-after: always;
        overflow: hidden;
      }
      
      .print-row { flex-direction: row !important; }
      .print-col-35 { width: 35% !important; }
      .print-col-50 { width: 50% !important; }
      .print-col-65 { width: 65% !important; padding-left: 1.5rem !important; border-left-width: 1px !important; }
      .print-grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
      .print-grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }

      input, textarea {
        background-color: transparent !important;
        border-color: transparent !important;
      }
      
      .ink-saver {
        background-color: white !important;
        color: black !important;
        border: 2px solid #444 !important;
      }
      .ink-saver input, .ink-saver textarea, .ink-saver .text-white { color: black !important; }
    }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // --- ИКОНКИ ---
    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        print: <g><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></g>,
        download: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></g>,
        upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></g>,
        clipboard: <g><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></g>,
        trash: <g><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></g>,
        x: <g><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></g>,
        plus: <path d="M12 5v14M5 12h14" />,
        minus: <path d="M5 12h14" />,
        heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />,
        file: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14 2z" />,
        lock: <path d="M12 17h.01M10 21h4a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm2-10V7a4 4 0 1 0-8 0v4" />
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          {icons[name] || <circle cx="12" cy="12" r="10" />}
        </svg>
      );
    };

    const MenuButton = ({ onClick, icon, label, colorClass, textColorClass = "text-white" }) => (
        <button onClick={onClick} className={`p-3 flex-1 md:flex-none flex justify-center items-center ${colorClass} ${textColorClass} rounded-xl md:rounded-lg transition-all shadow-md active:scale-95 group relative`}>
            <Icon name={icon} size={20} />
            <span className={`hidden md:block absolute right-full mr-3 top-1/2 -translate-y-1/2 px-2 py-1 bg-stone-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 whitespace-nowrap transition-opacity pointer-events-none font-bold font-header z-50 shadow-lg`}>
                {label}
            </span>
        </button>
    );

    const AutoGrowTextarea = ({ isPrinting, value, className, placeholder, onChange, style }) => {
      const textareaRef = useRef(null);
      useEffect(() => {
        if (textareaRef.current && !isPrinting) {
          textareaRef.current.style.height = 'auto';
          textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
        }
      }, [value, isPrinting]);

      if (isPrinting) {
        return <div className={`whitespace-pre-wrap break-words font-hand leading-snug ${className}`} style={style}>{value || '—'}</div>;
      }
      return (
        <textarea ref={textareaRef} value={value} onChange={onChange} placeholder={placeholder} rows={1} className={`overflow-hidden bg-transparent focus:outline-none focus:ring-1 focus:ring-stone-400/50 rounded resize-none font-hand leading-snug block text-base md:text-sm ${className}`} style={style} />
      );
    };

    const StatBox = ({ label, value, statKey, onUpdate }) => (
      <div className="flex flex-col items-center justify-center p-2 bg-stone-50 rounded-lg border border-stone-200 shadow-sm print:shadow-none print:border-stone-300 print:bg-stone-50 h-24 transition-colors hover:border-stone-400">
        <span className="text-[9px] uppercase font-bold text-stone-500 mb-1 text-center w-full leading-tight tracking-wide">{label}</span>
        <input type="number" value={value} onChange={(e) => onUpdate(statKey, e.target.value)} className="w-full text-center font-header font-bold text-5xl bg-transparent focus:outline-none text-stone-800 p-0 m-0 leading-none mt-1" />
      </div>
    );

    const SectionHeader = ({ title, onAdd, isPrinting }) => (
      <div className="flex justify-between items-end border-b-2 border-stone-300 mb-2 mt-4 pb-1">
        <h3 className="font-header font-bold text-lg text-stone-800 leading-none">{title}</h3>
        {!isPrinting && onAdd && (
          <button onClick={onAdd} className="text-stone-400 hover:text-stone-800 transition-colors p-1"><Icon name="plus" size={16} /></button>
        )}
      </div>
    );

    const ListItem = ({ value, onChange, onRemove, placeholder, isPrinting }) => (
      <div className="group flex items-start gap-2 mb-1">
        <div className="flex-1 relative">
           <AutoGrowTextarea isPrinting={isPrinting} value={value} onChange={onChange} className="w-full text-sm md:text-xs bg-stone-50/50 px-2 py-1 border-b border-stone-100 focus:border-stone-400 transition-colors print:bg-transparent print:border-stone-200" placeholder={placeholder} />
        </div>
        {!isPrinting && (
          <button onClick={onRemove} className="mt-0.5 text-stone-300 hover:text-red-500 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity" tabIndex="-1"><Icon name="minus" size={14} /></button>
        )}
      </div>
    );

    function VitruviyCharacterSheet() {
      const [name, setName] = useState('');
      const [characterClass, setCharacterClass] = useState('');
      const [race, setRace] = useState('');
      const [description, setDescription] = useState(''); 
      const [stats, setStats] = useState({ physique: 1, attention: 1, movement: 1, thinking: 1, communication: 1, will: 1 });
      const [traits, setTraits] = useState(['']);
      const [skills, setSkills] = useState(['']); 
      const [abilities, setAbilities] = useState(['']);
      const [character, setCharacter] = useState('');
      const [aesthetic, setAesthetic] = useState('');
      const [feature, setFeature] = useState('');
      const [motivation, setMotivation] = useState('');
      const [conflict, setConflict] = useState('');
      const [secret, setSecret] = useState('');
      const [consciousDesire, setConsciousDesire] = useState('');
      const [unconsciousDesire, setUnconsciousDesire] = useState('');
      const [weakness, setWeakness] = useState('');
      
      const [isPrinting, setIsPrinting] = useState(false);
      const [showJsonModal, setShowJsonModal] = useState(false);
      const [jsonInput, setJsonInput] = useState('');
      const fileInputRef = useRef(null);

      const updateStat = (stat, value) => {
        if (value === '') { setStats(prev => ({...prev, [stat]: ''})); return; }
        const val = parseInt(value);
        if (!isNaN(val)) setStats(prev => ({...prev, [stat]: Math.max(1, Math.min(6, val))}));
      };
      
      const handleListChange = (setter, list, index, value) => { const l = [...list]; l[index] = value; setter(l); };
      const addItem = (setter, list) => setter([...list, '']);
      const removeItem = (setter, list, index) => { if (list.length > 1) setter(list.filter((_, i) => i !== index)); };

      const sPhysique = Number(stats.physique) || 0;
      const sWill = Number(stats.will) || 0;
      const sMovement = Number(stats.movement) || 0;
      const health = sPhysique * 6;
      const inspiration = sWill * 2;
      const speed = sMovement * 2;
      const carryCapacity = sPhysique * 20;

      const applyData = (data) => {
        try {
          setName(data.имя || data.name || '');
          setCharacterClass(data.класс || data.class || '');
          setRace(data.раса || data.race || '');
          setDescription(data.описание || data.description || '');

          const ls = data.характеристики || data.stats || {};
          setStats({
              physique: ls.телосложение || ls.physique || 1, 
              attention: ls.внимание || ls.attention || 1,
              movement: ls.движение || ls.movement || 1, 
              thinking: ls.мышление || ls.thinking || 1,
              communication: ls.общение || ls.communication || 1, 
              will: ls.воля || ls.will || 1
          });

          setTraits(data.черты && data.черты.length ? data.черты : ['']);
          setSkills(data.умения && data.умения.length ? data.умения : ['']);
          setAbilities(data.способности && data.способности.length ? data.способности : ['']);

          const bg = data.предыстория || data.background || {};
          setCharacter(bg.характер || bg.character || ''); 
          setAesthetic(bg.эстетика || bg.aesthetic || ''); 
          setFeature(bg.фишка || bg.feature || '');
          setMotivation(bg.мотивация || bg.motivation || ''); 
          setConflict(bg.конфликт || bg.conflict || ''); 
          setSecret(bg.тайна || bg.secret || '');
          setConsciousDesire(bg.осознанное_желание || bg.consciousDesire || ''); 
          setUnconsciousDesire(bg.неосознанное_желание || bg.unconsciousDesire || ''); 
          setWeakness(bg.слабость || bg.weakness || '');
          return true;
        } catch (err) { console.error(err); return false; }
      };

      const clearAll = () => {
          if(!confirm("Вы уверены, что хотите очистить лист?")) return;
          setName(''); setCharacterClass(''); setRace(''); setDescription('');
          setStats({ physique: 1, attention: 1, movement: 1, thinking: 1, communication: 1, will: 1 });
          setTraits(['']); setSkills(['']); setAbilities(['']);
          setCharacter(''); setAesthetic(''); setFeature(''); setMotivation(''); 
          setConflict(''); setSecret(''); setConsciousDesire(''); setUnconsciousDesire(''); setWeakness('');
      };

      const saveAsJSON = () => {
        const characterData = {
          "имя": name,
          "класс": characterClass,
          "раса": race,
          "описание": description,
          "характеристики": { "телосложение": stats.physique, "внимание": stats.attention, "движение": stats.movement, "мышление": stats.thinking, "общение": stats.communication, "воля": stats.will },
          "черты": traits, "умения": skills, "способности": abilities,
          "предыстория": { "характер": character, "эстетика": aesthetic, "фишка": feature, "мотивация": motivation, "конфликт": conflict, "тайна": secret, "осознанное_желание": consciousDesire, "неосознанное_желание": unconsciousDesire, "слабость": weakness }
        };
        const dataStr = JSON.stringify(characterData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${name || 'персонаж'}_витрувий.json`;
        link.click();
        URL.revokeObjectURL(url);
      };

      const loadFromFile = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if(!applyData(data)) alert("Ошибка в структуре JSON");
          } catch (err) { alert("Невалидный JSON файл"); }
        };
        reader.readAsText(file);
        e.target.value = null; 
      };

      const loadFromText = () => {
        try {
          const data = JSON.parse(jsonInput);
          if(applyData(data)) { setShowJsonModal(false); setJsonInput(''); } else { alert("Ошибка данных"); }
        } catch(e) { alert("Ошибка парсинга JSON."); }
      };

      const printSheet = () => {
        setIsPrinting(true);
        setTimeout(() => { window.print(); setIsPrinting(false); }, 100);
      };

      return (
        <div className="min-h-screen py-4 md:py-8 print:py-0 print:bg-white flex flex-col items-center relative">
          
          {/* МОДАЛЬНОЕ ОКНО JSON */}
          {showJsonModal && (
            <div className="fixed inset-0 bg-stone-900/80 z-[100] flex items-center justify-center backdrop-blur-sm p-4 no-print">
               <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                  <div className="p-4 border-b border-stone-200 flex justify-between items-center bg-stone-50">
                    <h3 className="font-header font-bold text-lg">Импорт JSON</h3>
                    <button onClick={() => setShowJsonModal(false)}><Icon name="x" /></button>
                  </div>
                  <div className="p-4 flex-1 overflow-auto bg-stone-100">
                    <textarea className="w-full h-64 p-4 font-mono text-xs border rounded" placeholder='Вставьте код персонажа...' value={jsonInput} onChange={(e) => setJsonInput(e.target.value)}></textarea>
                  </div>
                  <div className="p-4 border-t flex justify-end gap-3 bg-stone-50">
                    <button onClick={() => setShowJsonModal(false)} className="px-4 py-2 text-sm font-bold text-stone-500">Отмена</button>
                    <button onClick={loadFromText} className="px-6 py-2 text-sm font-bold bg-stone-800 text-white rounded shadow">Загрузить</button>
                  </div>
               </div>
            </div>
          )}

          {/* МЕНЮ (ПЛАВАЮЩЕЕ НАД SAFE ZONE) */}
          <div className={`fixed z-[9999] transition-opacity ${isPrinting ? 'opacity-0 pointer-events-none' : 'opacity-100'}
              /* Мобильные стили: Плавающий остров */
              left-4 right-4
              bottom-[calc(1rem+env(safe-area-inset-bottom,0px))]
              bg-white border border-stone-300 rounded-2xl p-2 flex gap-2 justify-around shadow-2xl
              
              /* Десктопные стили: Сброс и перемещение в правый угол */
              md:top-4 md:right-4 md:bottom-auto md:left-auto 
              md:w-auto md:border md:rounded-xl md:flex-col md:shadow-2xl md:p-2
          `}>
            <MenuButton onClick={printSheet} icon="print" label="Печать" colorClass="bg-stone-800 hover:bg-stone-700" />
            <MenuButton onClick={saveAsJSON} icon="download" label="Сохранить" colorClass="bg-emerald-600 hover:bg-emerald-500" />
            <MenuButton onClick={() => fileInputRef.current?.click()} icon="upload" label="Загрузить" colorClass="bg-blue-600 hover:bg-blue-500" />
            <MenuButton onClick={() => setShowJsonModal(true)} icon="clipboard" label="Текст" colorClass="bg-amber-600 hover:bg-amber-500" />
            <div className="w-px bg-stone-300 mx-1 md:h-px md:w-full md:my-1"></div>
            <MenuButton onClick={clearAll} icon="trash" label="Сброс" colorClass="bg-white border border-stone-200 hover:bg-red-50" textColorClass="text-stone-400 hover:text-red-500" />
            <input ref={fileInputRef} type="file" className="hidden" accept=".json" onChange={loadFromFile} />
          </div>

          {/* --- СТРАНИЦА 1 --- */}
          <div className="sheet-page w-full max-w-[210mm] bg-white shadow-xl min-h-[auto] md:min-h-[297mm] p-4 md:p-12 relative mx-auto mb-4 md:mb-8 print:mb-0 rounded-none md:rounded-lg">
            
            {/* Шапка */}
            <div className="flex flex-col md:flex-row justify-between items-end border-b-4 border-stone-800 pb-4 mb-6 print-row">
              <div className="w-full md:w-1/2 pr-0 md:pr-4 mb-4 md:mb-0 print-col-50">
                 <label className="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Имя Персонажа</label>
                 <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full font-header font-bold text-3xl md:text-4xl text-stone-900 placeholder-stone-200 focus:outline-none bg-transparent leading-tight" placeholder="ИМЯ" />
              </div>
              <div className="flex gap-4 w-full md:w-1/2 justify-between md:justify-end items-end print-col-50">
                <div className="w-1/2 md:w-32">
                  <label className="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Класс</label>
                  <input type="text" value={characterClass} onChange={e => setCharacterClass(e.target.value)} className="w-full border-b border-stone-300 focus:border-stone-800 focus:outline-none pb-1 font-header font-bold bg-transparent text-base md:text-lg" placeholder="Класс" />
                </div>
                <div className="w-1/2 md:w-32">
                  <label className="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">Раса</label>
                  <input type="text" value={race} onChange={e => setRace(e.target.value)} className="w-full border-b border-stone-300 focus:border-stone-800 focus:outline-none pb-1 font-header font-bold bg-transparent text-base md:text-lg" placeholder="Раса" />
                </div>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-8 h-full print-row">
              {/* Левая колонка (Статы) */}
              <div className="w-full md:w-[35%] flex flex-col gap-6 print-col-35">
                
                <div className="grid grid-cols-2 gap-3">
                   <div className="col-span-2 p-3 rounded-lg border border-red-200 bg-red-50 print:bg-red-50 print:border-red-200">
                      <div className="flex justify-between items-center">
                        <span className="text-[10px] uppercase font-bold text-red-800/70">Здоровье</span>
                        <span className="text-[10px] text-red-800/50">Максимум</span>
                      </div>
                      <div className="text-4xl font-header font-black text-center text-red-900 mt-1">{health}</div>
                   </div>

                   <div className="p-2 rounded-lg border border-amber-200 bg-amber-50 text-center print:bg-amber-50 print:border-amber-200">
                      <span className="text-[10px] uppercase font-bold text-amber-800/70">Вдохновение</span>
                      <div className="text-2xl font-header font-black text-amber-900">{inspiration}</div>
                   </div>
                   <div className="p-2 rounded-lg border border-blue-200 bg-blue-50 text-center print:bg-blue-50 print:border-blue-200">
                      <span className="text-[10px] uppercase font-bold text-blue-800/70">Скорость</span>
                      <div className="text-2xl font-header font-black text-blue-900">{speed} <span className="text-xs font-sans font-normal">м</span></div>
                   </div>
                   <div className="col-span-2 p-2 rounded-lg border border-stone-200 bg-stone-100 flex justify-between items-center px-4 print:bg-stone-100">
                      <span className="text-[10px] uppercase font-bold text-stone-500">Нагрузка</span>
                      <div className="text-xl font-header font-bold text-stone-700">{carryCapacity} <span className="text-sm font-sans font-normal">кг</span></div>
                   </div>
                </div>

                <div>
                  <h3 className="font-header font-bold text-center text-stone-800 border-b-2 border-stone-800 pb-1 mb-4 uppercase tracking-widest text-sm">Характеристики</h3>
                  <div className="grid grid-cols-2 gap-3">
                    <StatBox label="Телосложение" value={stats.physique} statKey="physique" onUpdate={updateStat} />
                    <StatBox label="Внимание" value={stats.attention} statKey="attention" onUpdate={updateStat} />
                    <StatBox label="Движение" value={stats.movement} statKey="movement" onUpdate={updateStat} />
                    <StatBox label="Мышление" value={stats.thinking} statKey="thinking" onUpdate={updateStat} />
                    <StatBox label="Общение" value={stats.communication} statKey="communication" onUpdate={updateStat} />
                    <StatBox label="Воля" value={stats.will} statKey="will" onUpdate={updateStat} />
                  </div>
                </div>
              </div>

              {/* Правая колонка (Списки) */}
              <div className="w-full md:w-[65%] pl-0 md:pl-6 border-l-0 md:border-l border-stone-200 border-dashed print:border-stone-300 print-col-65">
                <SectionHeader title="Черты" onAdd={() => addItem(setTraits, traits)} isPrinting={isPrinting} />
                {traits.map((t, i) => (
                  <ListItem key={i} value={t} isPrinting={isPrinting} onChange={e => handleListChange(setTraits, traits, i, e.target.value)} onRemove={() => removeItem(setTraits, traits, i)} placeholder="Черта..." />
                ))}

                <SectionHeader title="Умения" onAdd={() => addItem(setSkills, skills)} isPrinting={isPrinting} />
                {skills.map((s, i) => (
                  <ListItem key={i} value={s} isPrinting={isPrinting} onChange={e => handleListChange(setSkills, skills, i, e.target.value)} onRemove={() => removeItem(setSkills, skills, i)} placeholder="Умение..." />
                ))}

                <SectionHeader title="Способности" onAdd={() => addItem(setAbilities, abilities)} isPrinting={isPrinting} />
                {abilities.map((a, i) => (
                  <ListItem key={i} value={a} isPrinting={isPrinting} onChange={e => handleListChange(setAbilities, abilities, i, e.target.value)} onRemove={() => removeItem(setAbilities, abilities, i)} placeholder="Способность..." />
                ))}
              </div>
            </div>
          </div>

          {/* --- СТРАНИЦА 2 --- */}
          <div className="sheet-page w-full max-w-[210mm] bg-white shadow-xl min-h-[auto] md:min-h-[297mm] p-4 md:p-12 mx-auto print:mt-0 print:shadow-none rounded-none md:rounded-lg">
            
            <div className="flex items-center gap-4 mb-8 pb-2 border-b-4 border-stone-800">
                <div className="bg-stone-800 text-white p-2 rounded"><Icon name="file" size={24} /></div>
                <h2 className="font-header font-black text-2xl md:text-3xl text-stone-800 uppercase">Личное Дело</h2>
                <div className="hidden md:block ml-auto text-sm text-stone-400 font-header uppercase tracking-widest">Конфиденциально</div>
            </div>
            
            <div className="mb-8 bg-stone-50 p-6 rounded-xl border border-stone-200 relative print:bg-stone-50">
              <div className="absolute -top-3 left-6 bg-white px-2 text-xs font-bold text-stone-400 uppercase tracking-widest">Внешность и История</div>
              <AutoGrowTextarea isPrinting={isPrinting} value={description} onChange={e => setDescription(e.target.value)} className="w-full bg-transparent text-stone-800 text-base md:text-sm" placeholder="Опишите внешность..." style={{minHeight: '80px'}} />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 print-row print-grid-3">
              {[
                 { l: "Характер", v: character, s: setCharacter, ph: "Добрый..." },
                 { l: "Эстетика", v: aesthetic, s: setAesthetic, ph: "Плащ..." },
                 { l: "Фишка", v: feature, s: setFeature, ph: "Монета..." }
              ].map((field, idx) => (
                <div key={idx} className="border-t-2 border-stone-300 pt-2">
                  <label className="block text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-1">{field.l}</label>
                  <AutoGrowTextarea isPrinting={isPrinting} value={field.v} onChange={e => field.s(e.target.value)} className="w-full bg-transparent font-hand text-sm" placeholder={field.ph} />
                </div>
              ))}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 print-grid-2">
              <div className="space-y-6">
                 <h3 className="font-header font-bold text-stone-800 text-lg border-b border-stone-200 pb-1">Драйверы</h3>
                 <div>
                    <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 bg-blue-500 rounded-full"></span><label className="text-xs font-bold text-stone-500 uppercase">Мотивация</label></div>
                    <AutoGrowTextarea isPrinting={isPrinting} value={motivation} onChange={e => setMotivation(e.target.value)} className="w-full italic text-stone-700 pl-4 border-l-2 border-stone-100 text-sm" placeholder="Цель..." />
                 </div>
                 <div>
                    <div className="flex items-center gap-2 mb-1"><span className="w-2 h-2 bg-amber-500 rounded-full"></span><label className="text-xs font-bold text-stone-500 uppercase">Конфликт</label></div>
                    <AutoGrowTextarea isPrinting={isPrinting} value={conflict} onChange={e => setConflict(e.target.value)} className="w-full italic text-stone-700 pl-4 border-l-2 border-stone-100 text-sm" placeholder="Преграда..." />
                 </div>
                 <div className="pt-4">
                    <div className="flex items-center gap-2 mb-1 text-stone-800"><Icon name="lock" size={14} /><label className="text-xs font-bold uppercase">Тайна</label></div>
                    <div className="bg-stone-100 p-3 rounded border border-stone-200 print:bg-stone-100">
                        <AutoGrowTextarea isPrinting={isPrinting} value={secret} onChange={e => setSecret(e.target.value)} className="w-full text-stone-800 text-sm" placeholder="Секрет..." />
                    </div>
                 </div>
              </div>
              
              <div className="bg-stone-800 text-stone-200 p-6 rounded-xl shadow-inner ink-saver">
                 <h3 className="font-header font-bold text-white/90 text-lg border-b border-stone-600 pb-1 mb-6 print:border-stone-300 print:text-black">Глубинная Психология</h3>
                 <div className="mb-6">
                    <label className="block text-[10px] font-bold text-stone-400 uppercase mb-1">Осознанное Желание</label>
                    <AutoGrowTextarea isPrinting={isPrinting} value={consciousDesire} onChange={e => setConsciousDesire(e.target.value)} className="w-full text-sm font-hand text-white placeholder-stone-600 print:text-black" placeholder="Я хочу..." />
                 </div>
                 <div className="mb-8">
                    <label className="block text-[10px] font-bold text-stone-400 uppercase mb-1">Неосознанное Желание</label>
                    <AutoGrowTextarea isPrinting={isPrinting} value={unconsciousDesire} onChange={e => setUnconsciousDesire(e.target.value)} className="w-full text-sm font-hand text-white placeholder-stone-600 print:text-black" placeholder="Мне нужно..." />
                 </div>
                 <div className="border-t border-stone-600 pt-4 print:border-stone-300">
                    <div className="flex items-center gap-2 text-red-400 mb-2 print:text-red-800"><Icon name="heart" size={16} /><label className="text-xs font-bold uppercase">Слабость</label></div>
                    <AutoGrowTextarea isPrinting={isPrinting} value={weakness} onChange={e => setWeakness(e.target.value)} className="w-full text-sm font-hand text-red-200 placeholder-red-900/30 print:text-black" placeholder="Уязвимость..." />
                 </div>
              </div>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VitruviyCharacterSheet />);
  </script>
</body>
</html>
